## ES极客时间

[TOC]

**课件地址：https://github.com/onebirdrocks/geektime-ELK**

### 内容概述

![image-20200423192052699](assets/image-20200423192052699.png)

![image-20200423192217719](assets/image-20200423192217719.png)

### Elasticsearch 简介

![image-20200423192535949](assets/image-20200423192535949.png)

![image-20200423192615018](assets/image-20200423192615018.png)

![image-20200423192713261](assets/image-20200423192713261.png)

![image-20200423192739596](assets/image-20200423192739596.png)

![image-20200423192800375](assets/image-20200423192800375.png)

![image-20200423192952964](assets/image-20200423192952964.png)

![image-20200423193050821](assets/image-20200423193050821.png)

![image-20200423193149500](assets/image-20200423193149500.png)

### Elasticsearch家族成员及应用场景

![image-20200423193322663](assets/image-20200423193322663.png)

![image-20200423193435859](assets/image-20200423193435859.png)

![image-20200423193519827](assets/image-20200423193519827.png)

![image-20200423193530513](assets/image-20200423193530513.png)

![image-20200423193606697](assets/image-20200423193606697.png)

![image-20200423193621746](assets/image-20200423193621746.png)

![image-20200423193724399](assets/image-20200423193724399.png)

![image-20200423193813225](assets/image-20200423193813225.png)

![image-20200423193828283](assets/image-20200423193828283.png)

![image-20200423193904073](assets/image-20200423193904073.png)

![image-20200423193930195](assets/image-20200423193930195.png)

### Elasticsearch 的安装与简单配置

![image-20200423194148546](assets/image-20200423194148546.png)

![image-20200423194215375](assets/image-20200423194215375.png)

![image-20200423194259647](assets/image-20200423194259647.png)

![image-20200423194353019](assets/image-20200423194353019.png)

![image-20200423194546863](assets/image-20200423194546863.png)

![image-20200423194703671](assets/image-20200423194703671.png)

![image-20200423194756490](assets/image-20200423194756490.png)

![image-20200423194849869](assets/image-20200423194849869.png)

![image-20200423194933265](assets/image-20200423194933265.png)

```
-d 将Elasticsearch 运行在后台
```

![image-20200423195029368](assets/image-20200423195029368.png)

### Kibana的安装与界面预览

![image-20200423195213421](assets/image-20200423195213421.png)

![image-20200423195343164](assets/image-20200423195343164.png)

![image-20200423195430918](assets/image-20200423195430918.png)

![image-20200423195441655](assets/image-20200423195441655.png)

![image-20200423195457215](assets/image-20200423195457215.png)

### Docker中运行Elasticsearch、Kibana和Celebro

![image-20200423195644813](assets/image-20200423195644813.png)

![image-20200423195710505](assets/image-20200423195710505.png)

![image-20200423195846084](assets/image-20200423195846084.png)

```
Celebro 界面
```

### Logstash 的安装与数据导入

![image-20200423200535577](assets/image-20200423200535577.png)

![image-20200423200604457](assets/image-20200423200604457.png)

```
Movielens 测试数据集
```

### 基本概念：索引、文档和RESTAPI

![image-20200423201641336](assets/image-20200423201641336.png)

![image-20200423201744470](assets/image-20200423201744470.png)

![image-20200423201818646](assets/image-20200423201818646.png)

![image-20200423201914408](assets/image-20200423201914408.png)

![image-20200423202031693](assets/image-20200423202031693.png)

![image-20200423202159471](assets/image-20200423202159471.png)

![image-20200423202323823](assets/image-20200423202323823.png)

![image-20200423202418724](assets/image-20200423202418724.png)

![image-20200423210802610](assets/image-20200423210802610.png)

![image-20200423210901118](assets/image-20200423210901118.png)

### 基本概念：节点、集群分片及副本

![image-20200423211051198](assets/image-20200423211051198.png)

![image-20200423211149503](assets/image-20200423211149503.png)

![image-20200423211234822](assets/image-20200423211234822.png)

![image-20200423211403710](assets/image-20200423211403710.png)

![image-20200423211502582](assets/image-20200423211502582.png)

![image-20200423211605031](assets/image-20200423211605031.png)

![image-20200423211732070](assets/image-20200423211732070.png)

![image-20200423211909063](assets/image-20200423211909063.png)

![image-20200423212028751](assets/image-20200423212028751.png)

![image-20200423212228566](assets/image-20200423212228566.png)

![image-20200423212341158](assets/image-20200423212341158.png)

![image-20200423212422875](assets/image-20200423212422875.png)

![image-20200423212518323](assets/image-20200423212518323.png)

![image-20200423212643396](assets/image-20200423212643396.png)

![image-20200423212724773](assets/image-20200423212724773.png)

![image-20200423212749098](assets/image-20200423212749098.png)

### 文档基本CURD与批量操作（bulk/mget/msearch）

![image-20200423213010899](assets/image-20200423213010899.png)

![image-20200423213115756](assets/image-20200423213115756.png)

![image-20200423213157068](assets/image-20200423213157068.png)

```
_version: 32 表示文档进行了 32 次的改动
```

![image-20200423213316745](assets/image-20200423213316745.png)

```
index的时候，如果 _id 为1 的文档存在，则删除后，_version 版本增加
```

![image-20200423213539135](assets/image-20200423213539135.png)

![image-20200423213617693](assets/image-20200423213617693.png)

![image-20200423213650422](assets/image-20200423213650422.png)

![image-20200423213740854](assets/image-20200423213740854.png)

```
重复执行 会报版本冲突
```

![image-20200423213819741](assets/image-20200423213819741.png)

![image-20200423214126015](assets/image-20200423214126015.png)

![image-20200423214234639](assets/image-20200423214234639.png)

![image-20200423214505009](assets/image-20200423214505009.png)

![image-20200423214544213](assets/image-20200423214544213.png)

![image-20200423214631236](assets/image-20200423214631236.png)

### 倒排索引简介

![image-20200423214821492](assets/image-20200423214821492.png)

![image-20200423214904357](assets/image-20200423214904357.png)

![image-20200423214941563](assets/image-20200423214941563.png)

![image-20200423215016203](assets/image-20200423215016203.png)

```
右边的表格就是倒排索引：
	Elasticsearch 出现3次， 1:1 表示出现在文档id为1，的第二个分词上
```

![image-20200423215335613](assets/image-20200423215335613.png)

![image-20200423215523787](assets/image-20200423215523787.png)

```
以文档ID=1 为例：
	TF=1： Elasticsearch 在文档中出现的频率1次
	Position： 第二个人分词
	Offset：字符是从第10个字符到第23个字符
```

![image-20200423215802319](assets/image-20200423215802319.png)

### 通过analyzer（分词器）进行分词

![image-20200423215954402](assets/image-20200423215954402.png)

```
分词过程把 单词都转换为 小写的了
```

![image-20200423220216198](assets/image-20200423220216198.png)

![image-20200423220327623](assets/image-20200423220327623.png)

![image-20200423220436074](assets/image-20200423220436074.png)

![image-20200423220512552](assets/image-20200423220512552.png)

![image-20200423220702007](assets/image-20200423220702007.png)

```
按照 空格进行拆分， 大写转换为小写， in the 这类的停用词 没有去除
```

![image-20200423220850861](assets/image-20200423220850861.png)

![image-20200423220929445](assets/image-20200423220929445.png)

![image-20200423220954331](assets/image-20200423220954331.png)

![image-20200423221009051](assets/image-20200423221009051.png)

![image-20200423221056399](assets/image-20200423221056399.png)

![image-20200423221115038](assets/image-20200423221115038.png)

![image-20200423221230180](assets/image-20200423221230180.png)

![image-20200423221249628](assets/image-20200423221249628.png)

![image-20200423221307236](assets/image-20200423221307236.png)

![image-20200423221347196](assets/image-20200423221347196.png)

```
按照空格和 非字符符合进行切分
```

![image-20200423221526004](assets/image-20200423221526004.png)

![image-20200423221622979](assets/image-20200423221622979.png)

![image-20200423221742143](assets/image-20200423221742143.png)

![image-20200423221826224](assets/image-20200423221826224.png)

![image-20200423221858290](assets/image-20200423221858290.png)

![image-20200423221928795](assets/image-20200423221928795.png)

![image-20200423222003621](assets/image-20200423222003621.png)

### SearchAPI概览

![image-20200423222118645](assets/image-20200423222118645.png)

![image-20200423222201482](assets/image-20200423222201482.png)

![image-20200423222321665](assets/image-20200423222321665.png)

![image-20200423222401663](assets/image-20200423222401663.png)

![image-20200423222457969](assets/image-20200423222457969.png)

```
took 的单位 为 毫秒
```

![image-20200423222728144](assets/image-20200423222728144.png)

![image-20200423222851993](assets/image-20200423222851993.png)

![image-20200423222914865](assets/image-20200423222914865.png)

![image-20200423222939313](assets/image-20200423222939313.png)

![image-20200423223105552](assets/image-20200423223105552.png)

### URI Search详解

![image-20200423223248647](assets/image-20200423223248647.png)

![image-20200423223544199](assets/image-20200423223544199.png)

![image-20200423223633540](assets/image-20200423223633540.png)

![image-20200423223714802](assets/image-20200423223714802.png)

```
对所有的字段都进行了 2012 的查找
```

![image-20200423223818002](assets/image-20200423223818002.png)

![image-20200423223922505](assets/image-20200423223922505.png)

![image-20200423224000547](assets/image-20200423224000547.png)

![image-20200423224055307](assets/image-20200423224055307.png)

![image-20200423224448535](assets/image-20200423224448535.png)

```
使用 小括号，使用的是 booleanQuery 的查询
```

![image-20200423224134899](assets/image-20200423224134899.png)

![image-20200423224154289](assets/image-20200423224154289.png)

```
没有对 beautiful mind 添加 小括号 括起来，beautiful 使用的TermQuery 而mind 使用的是 DisjunctionMaxQuery （泛查询）
```

![image-20200423224518843](assets/image-20200423224518843.png)

![image-20200423224602359](assets/image-20200423224602359.png)

![image-20200423224632319](assets/image-20200423224632319.png)

![image-20200423224705977](assets/image-20200423224705977.png)

```
%2B 在 URI query 里面代表的是 + 号
```

![image-20200423224851734](assets/image-20200423224851734.png)

![image-20200423224919792](assets/image-20200423224919792.png)

![image-20200423225000445](assets/image-20200423225000445.png)

![image-20200423225024297](assets/image-20200423225024297.png)

![image-20200423225100055](assets/image-20200423225100055.png)

![image-20200423225130374](assets/image-20200423225130374.png)

### Request Body 与QueryDSL简介

![image-20200423225248536](assets/image-20200423225248536.png)

![image-20200423225317191](assets/image-20200423225317191.png)

![image-20200423225342937](assets/image-20200423225342937.png)

![image-20200423225505035](assets/image-20200423225505035.png)

![image-20200423225545697](assets/image-20200423225545697.png)

![image-20200423225646944](assets/image-20200423225646944.png)

![image-20200423225707898](assets/image-20200423225707898.png)

![image-20200423225755518](assets/image-20200423225755518.png)

```
查询的次顺序出现，slop 1，代表中间可以有一个其他的词
```

![image-20200423225901808](assets/image-20200423225901808.png)

```
默认 是 OR 的关系
```

![image-20200423225934004](assets/image-20200423225934004.png)

![image-20200423230012352](assets/image-20200423230012352.png)

### QueryString 和SimpleQueryString 查询

![image-20200423230124365](assets/image-20200423230124365.png)

![image-20200423230215639](assets/image-20200423230215639.png)

![image-20200423230310804](assets/image-20200423230310804.png)

![image-20200423230335083](assets/image-20200423230335083.png)

![image-20200423230418739](assets/image-20200423230418739.png)

![image-20200423230439620](assets/image-20200423230439620.png)

#### DynamicMapping和常见的字段类型

![image-20200423230634127](assets/image-20200423230634127.png)

![image-20200423230859164](assets/image-20200423230859164.png)

![image-20200423230941756](assets/image-20200423230941756.png)

![image-20200423231054464](assets/image-20200423231054464.png)

![image-20200423231155098](assets/image-20200423231155098.png)

![image-20200423231259305](assets/image-20200423231259305.png)

![image-20200423231413284](assets/image-20200423231413284.png)

![image-20200423231533812](assets/image-20200423231533812.png)

![image-20200423231714088](assets/image-20200423231714088.png)

![image-20200423231730982](assets/image-20200423231730982.png)

![image-20200423231748439](assets/image-20200423231748439.png)

![image-20200423231839656](assets/image-20200423231839656.png)

![image-20200423231909786](assets/image-20200423231909786.png)

### 显式Mapping设置和常见参数介绍

![image-20200423232012338](assets/image-20200423232012338.png)

![image-20200423232053745](assets/image-20200423232053745.png)

![image-20200423232159698](assets/image-20200423232159698.png)

```
敏感信息 可以将 index 设置为 false，也可以减少 倒排索引的 存储空间
```

![image-20200423232408100](assets/image-20200423232408100.png)

![image-20200423232444932](assets/image-20200423232444932.png)

![image-20200423232526818](assets/image-20200423232526818.png)

![image-20200423232619208](assets/image-20200423232619208.png)

![image-20200423232800845](assets/image-20200423232800845.png)

```
设置 null_value: "NULL" 后，通过 NULL 字符串进行查询，查出来的 结果是 真正的null
```

![image-20200423232930558](assets/image-20200423232930558.png)

```
通过 fullname 查询出来的结果，没有 fullname 的字段
```

![image-20200423233112293](assets/image-20200423233112293.png)

```
第一次是写入的 是 reading 的字符串
第二次重新 index 数据进去，是一个 字符数组，但是mapping信息依然是 text的类型，而不是 字符数组
```

### 多字段特性以及mapping中配置自定义Analyzer

![image-20200423233630710](assets/image-20200423233630710.png)

![image-20200423233743611](assets/image-20200423233743611.png)

```
精确值和全文本
```

![image-20200423234107172](assets/image-20200423234107172.png)

![image-20200423234129770](assets/image-20200423234129770.png)

![image-20200423234309795](assets/image-20200423234309795.png)

![image-20200423234355811](assets/image-20200423234355811.png)

![image-20200423234452459](assets/image-20200423234452459.png)

![image-20200423234530667](assets/image-20200423234530667.png)

![image-20200423234652375](assets/image-20200423234652375.png)

![image-20200423234733022](assets/image-20200423234733022.png)

```
字符串 替换
```

![image-20200423234832811](assets/image-20200423234832811.png)

![image-20200423234907149](assets/image-20200423234907149.png)

![image-20200423234946841](assets/image-20200423234946841.png)

![image-20200423235135951](assets/image-20200423235135951.png)

### Index Template 和 Dynamic Template

![image-20200423235458538](assets/image-20200423235458538.png)

![image-20200423235546510](assets/image-20200423235546510.png)

![image-20200423235704408](assets/image-20200423235704408.png)

![image-20200424000002702](assets/image-20200424000002702.png)

![image-20200424000114398](assets/image-20200424000114398.png)

![image-20200424000339035](assets/image-20200424000339035.png)

### Elasticsearch 聚合分析简介

![image-20200424000424495](assets/image-20200424000424495.png)

![image-20200424000519169](assets/image-20200424000519169.png)

![image-20200424000555373](assets/image-20200424000555373.png)

![image-20200424000649075](assets/image-20200424000649075.png)

![image-20200424000734811](assets/image-20200424000734811.png)

![image-20200424000814895](assets/image-20200424000814895.png)

![image-20200424000920109](assets/image-20200424000920109.png)

![image-20200424001021396](assets/image-20200424001021396.png)

![image-20200424001153098](assets/image-20200424001153098.png)

![image-20200424001414389](assets/image-20200424001414389.png)

![image-20200424001613400](assets/image-20200424001613400.png)

![image-20200424001545288](assets/image-20200424001545288.png)

```
stats 聚合输出count/min/max/avg/sum 多个信息
```

### 第一部分总结

![image-20200424001849989](assets/image-20200424001849989.png)

![image-20200424002030141](assets/image-20200424002030141.png)

![image-20200424002154700](assets/image-20200424002154700.png)

![image-20200424002305231](assets/image-20200424002305231.png)

![image-20200424002414488](assets/image-20200424002414488.png)

![image-20200424002826585](assets/image-20200424002826585.png)

![image-20200424002908604](assets/image-20200424002908604.png)

![image-20200424002943380](assets/image-20200424002943380.png)

![image-20200424003027091](assets/image-20200424003027091.png)

![image-20200424003120562](assets/image-20200424003120562.png)

### 基于词项（Term）和基于全文的搜索

![image-20200424003317681](assets/image-20200424003317681.png)

```
term 的查询对于 输入的查询项 不进行分词处理
term 是 表达语意的最小单元，不可再分
```

![image-20200424133833125](assets/image-20200424133833125.png)

![image-20200424133957350](assets/image-20200424133957350.png)

```
这个查询没有返回结果是因为，ES 分词处理 iPhone 转换为了 小写的iphone进行倒排索引；而 使用term不进行 分词转换
```

![image-20200424134101476](assets/image-20200424134101476.png)

![image-20200424134141269](assets/image-20200424134141269.png)

![image-20200424134212735](assets/image-20200424134212735.png)

```
ES 的分词器，执行的分词结果
```

![image-20200424134233896](assets/image-20200424134233896.png)

```
使用 term: "xhdk" 这个最小的分词单元，进行文档的匹配，查询到结果
```

![image-20200424134313991](assets/image-20200424134313991.png)

```
完全匹配的话，使用 keyword
```

![image-20200424134345456](assets/image-20200424134345456.png)

![image-20200424134651391](assets/image-20200424134651391.png)

![image-20200424135342144](assets/image-20200424135342144.png)

![image-20200424135415650](assets/image-20200424135415650.png)

![image-20200424135428500](assets/image-20200424135428500.png)

![image-20200424135456201](assets/image-20200424135456201.png)

![image-20200424135513347](assets/image-20200424135513347.png)

![image-20200424135608838](assets/image-20200424135608838.png)

![image-20200424135701556](assets/image-20200424135701556.png)

### 结构化搜索

![image-20200424135822935](assets/image-20200424135822935.png)

![image-20200424135919176](assets/image-20200424135919176.png)

![image-20200424140110200](assets/image-20200424140110200.png)

![image-20200424140144033](assets/image-20200424140144033.png)

![image-20200424140216624](assets/image-20200424140216624.png)

![image-20200424140247584](assets/image-20200424140247584.png)

![image-20200424140310777](assets/image-20200424140310777.png)

![image-20200424140320187](assets/image-20200424140320187.png)

![image-20200424140346493](assets/image-20200424140346493.png)

![image-20200424140452406](assets/image-20200424140452406.png)

![image-20200424140522996](assets/image-20200424140522996.png)

![image-20200424140638650](assets/image-20200424140638650.png)

### 搜索的相关性算分

![image-20200424140751888](assets/image-20200424140751888.png)

![image-20200424140920066](assets/image-20200424140920066.png)

![image-20200424141114551](assets/image-20200424141114551.png)

![image-20200424141241834](assets/image-20200424141241834.png)

![image-20200424141335917](assets/image-20200424141335917.png)

![image-20200424141357375](assets/image-20200424141357375.png)

![image-20200424141426404](assets/image-20200424141426404.png)

```
创建索引的时候，可以自定义 算分
```

![image-20200424141533572](assets/image-20200424141533572.png)

![image-20200424141657621](assets/image-20200424141657621.png)

```
文档 2 的 长度更多，得分就相对较高
```

![image-20200424141809803](assets/image-20200424141809803.png)

![image-20200424141900612](assets/image-20200424141900612.png)

### Query&Filter与多字符串多字段查询

![image-20200424142103530](assets/image-20200424142103530.png)

![image-20200424142204724](assets/image-20200424142204724.png)

![image-20200424142333788](assets/image-20200424142333788.png)

![image-20200424142427400](assets/image-20200424142427400.png)

![image-20200424142518631](assets/image-20200424142518631.png)

![image-20200424142559150](assets/image-20200424142559150.png)

![image-20200424142612659](assets/image-20200424142612659.png)

![image-20200424142659670](assets/image-20200424142659670.png)

![image-20200424142708612](assets/image-20200424142708612.png)

![image-20200424142800755](assets/image-20200424142800755.png)

```
通过 bool 的嵌套，brown和red 加起来的权重，才和上一层的权重一样
```

![image-20200424142930933](assets/image-20200424142930933.png)

![image-20200424143048296](assets/image-20200424143048296.png)

![image-20200424143111063](assets/image-20200424143111063.png)

![image-20200424143138753](assets/image-20200424143138753.png)

![image-20200424143224120](assets/image-20200424143224120.png)

![image-20200424143319975](assets/image-20200424143319975.png)

![image-20200424143343609](assets/image-20200424143343609.png)

### 单字符串多字段的查询：DisMaxQuery

![image-20200424143628116](assets/image-20200424143628116.png)

![image-20200424143745111](assets/image-20200424143745111.png)

```
使用 should 查询，文档 1 的得分高
```

![image-20200424143832097](assets/image-20200424143832097.png)

![image-20200424143953382](assets/image-20200424143953382.png)

![image-20200424144034689](assets/image-20200424144034689.png)

![image-20200424144352471](assets/image-20200424144352471.png)

```
搜索 Quick pets 的时候，两个搜索的评分一样
```

![image-20200424144548868](assets/image-20200424144548868.png)

![image-20200424144626098](assets/image-20200424144626098.png)

```
文档2的评分高了，因为 title 中出现了 pets，body中出现了 quick
文档1 只有title 中出现了 quick
```

### 单字符串多字段的查询：MultiMatch

![image-20200424144954697](assets/image-20200424144954697.png)

![image-20200424145120876](assets/image-20200424145120876.png)

![image-20200424145601120](assets/image-20200424145601120.png)

![image-20200424145703268](assets/image-20200424145703268.png)

```
使用 english 的分词器，会把 barking 分词为 bark， title的算分一样，而 文档1 更短，得分就更高
```

![image-20200424145955881](assets/image-20200424145955881.png)

```
对 title.std 这个子字段，使用 std 分词器，提高 精确度
```

![image-20200424150145247](assets/image-20200424150145247.png)

```
指定 multi_match 的类型为 most_fields，可以对子字段使用标准分词器
```

![image-20200424150339287](assets/image-20200424150339287.png)

```
title^10 为字段增加权重(boosting)
```

![image-20200424150445168](assets/image-20200424150445168.png)

![image-20200424150540273](assets/image-20200424150540273.png)

### 多语言及中文分词与检索

![image-20200424150753752](assets/image-20200424150753752.png)

![image-20200424150912456](assets/image-20200424150912456.png)

![image-20200424151247143](assets/image-20200424151247143.png)

![image-20200424151445927](assets/image-20200424151445927.png)

![image-20200424151644605](assets/image-20200424151644605.png)

![image-20200424151716903](assets/image-20200424151716903.png)

![image-20200424151734535](assets/image-20200424151734535.png)

![image-20200424151838315](assets/image-20200424151838315.png)

![image-20200424151900669](assets/image-20200424151900669.png)

![image-20200424151917018](assets/image-20200424151917018.png)

![image-20200424151935371](assets/image-20200424151935371.png)

![image-20200424152040244](assets/image-20200424152040244.png)

![image-20200424152147213](assets/image-20200424152147213.png)

```
pinyin 分词器
```

![image-20200424152220655](assets/image-20200424152220655.png)

![image-20200424152242832](assets/image-20200424152242832.png)

### Space Jam，一次全文搜索的实例

![image-20200424152354253](assets/image-20200424152354253.png)

![image-20200424152427961](assets/image-20200424152427961.png)

![image-20200424152456304](assets/image-20200424152456304.png)

![image-20200424152550930](assets/image-20200424152550930.png)

![image-20200424153029628](assets/image-20200424153029628.png)

![image-20200424153108695](assets/image-20200424153108695.png)

![image-20200424153136286](assets/image-20200424153136286.png)

### 使用Search Template和Index Alias 查询

![image-20200424153338805](assets/image-20200424153338805.png)

![image-20200424153506880](assets/image-20200424153506880.png)

```
定义查询的模板
```

![image-20200424153601770](assets/image-20200424153601770.png)

```
前端查询
```

![image-20200424153639183](assets/image-20200424153639183.png)

![image-20200424153716464](assets/image-20200424153716464.png)

![image-20200424153818601](assets/image-20200424153818601.png)

### 综合排序：Function Score Query 优化算分

![image-20200424153922652](assets/image-20200424153922652.png)

![image-20200424154036429](assets/image-20200424154036429.png)

![image-20200424154145667](assets/image-20200424154145667.png)

![image-20200424154308862](assets/image-20200424154308862.png)

```
只有投票数不一样
```

![image-20200424154344159](assets/image-20200424154344159.png)

![image-20200424154411528](assets/image-20200424154411528.png)

```
因 投票数差异较大，算分就差异较大，通过使用 Modifier 进行平滑的处理
```

![image-20200424154521142](assets/image-20200424154521142.png)

![image-20200424154616429](assets/image-20200424154616429.png)

![image-20200424154630330](assets/image-20200424154630330.png)

![image-20200424154807526](assets/image-20200424154807526.png)

```
max_boost 控制最高算分在 3
```

![image-20200424154849620](assets/image-20200424154849620.png)

### Term&Phrase suggester 搜索建议

![image-20200424155213500](assets/image-20200424155213500.png)

![image-20200424155247946](assets/image-20200424155247946.png)

![image-20200424155402847](assets/image-20200424155402847.png)

![image-20200424155530725](assets/image-20200424155530725.png)

![image-20200424155653732](assets/image-20200424155653732.png)

![image-20200424160745547](assets/image-20200424160745547.png)

### 自动补全与基于上下文的提示

![image-20200424160935064](assets/image-20200424160935064.png)

![image-20200424161011909](assets/image-20200424161011909.png)

![image-20200424161044776](assets/image-20200424161044776.png)

![image-20200424161127393](assets/image-20200424161127393.png)

![image-20200424161146312](assets/image-20200424161146312.png)

![image-20200424161224016](assets/image-20200424161224016.png)

![image-20200424161946852](assets/image-20200424161946852.png)

### 配置跨集群搜索

![image-20200424162124622](assets/image-20200424162124622.png)

![image-20200424162219267](assets/image-20200424162219267.png)

![image-20200424162317910](assets/image-20200424162317910.png)

![image-20200424162345835](assets/image-20200424162345835.png)

![image-20200424162614787](assets/image-20200424162614787.png)

![image-20200424162702652](assets/image-20200424162702652.png)

```
以 *users ，可以看到 其他集群的数据
```

### 集群分布式模型及选主与脑裂问题

![image-20200424162843396](assets/image-20200424162843396.png)

![image-20200424162912084](assets/image-20200424162912084.png)

![image-20200424163001650](assets/image-20200424163001650.png)

![image-20200424163035541](assets/image-20200424163035541.png)

![image-20200424163239579](assets/image-20200424163239579.png)

![image-20200424163442707](assets/image-20200424163442707.png)

![image-20200424163537474](assets/image-20200424163537474.png)

![image-20200424163629059](assets/image-20200424163629059.png)

![image-20200424163706194](assets/image-20200424163706194.png)

![image-20200424163803612](assets/image-20200424163803612.png)

![image-20200424163929359](assets/image-20200424163929359.png)

![image-20200424164021274](assets/image-20200424164021274.png)

### 分片与集群的故障转移

![image-20200424164130695](assets/image-20200424164130695.png)

![image-20200424164150198](assets/image-20200424164150198.png)

![image-20200424164245585](assets/image-20200424164245585.png)

![image-20200424164316799](assets/image-20200424164316799.png)

![image-20200424164338263](assets/image-20200424164338263.png)

![image-20200424164352307](assets/image-20200424164352307.png)

![image-20200424164500128](assets/image-20200424164500128.png)

![image-20200424164536718](assets/image-20200424164536718.png)

### 文档分布式存储

![image-20200424164834207](assets/image-20200424164834207.png)

![image-20200424165001549](assets/image-20200424165001549.png)

![image-20200424165059391](assets/image-20200424165059391.png)

![image-20200424165158469](assets/image-20200424165158469.png)

### 分片及其生命周期

![image-20200424165320596](assets/image-20200424165320596.png)

![image-20200424165425759](assets/image-20200424165425759.png)

![image-20200424165552461](assets/image-20200424165552461.png)

![image-20200424165728749](assets/image-20200424165728749.png)

![image-20200424165925547](assets/image-20200424165925547.png)

![image-20200424170034764](assets/image-20200424170034764.png)

![image-20200424170119401](assets/image-20200424170119401.png)

### 剖析分布式查询及相关性算分

![image-20200424170246059](assets/image-20200424170246059.png)

![image-20200424170345916](assets/image-20200424170345916.png)

![image-20200424170540028](assets/image-20200424170540028.png)

![image-20200424170633274](assets/image-20200424170633274.png)

![image-20200424170800327](assets/image-20200424170800327.png)

### 排序及DocValues&Fielddata

![image-20200424171047944](assets/image-20200424171047944.png)

![image-20200424171141838](assets/image-20200424171141838.png)

![image-20200424171313357](assets/image-20200424171313357.png)

![image-20200424171346637](assets/image-20200424171346637.png)

![image-20200424171448969](assets/image-20200424171448969.png)

![image-20200424171558030](assets/image-20200424171558030.png)

### 分页和遍历：From,Size,SearchAfter&ScrollAPI

![image-20200424171749550](assets/image-20200424171749550.png)

![image-20200424171919408](assets/image-20200424171919408.png)

![image-20200424172058270](assets/image-20200424172058270.png)

![image-20200424172249475](assets/image-20200424172249475.png)

![image-20200424172325403](assets/image-20200424172325403.png)

![image-20200424172359486](assets/image-20200424172359486.png)

![image-20200424172444315](assets/image-20200424172444315.png)

```
只能查到 创建快照的时候的文档，创建之后 有新的数据写入时查不到的
```

![image-20200424172653035](assets/image-20200424172653035.png)

### 处理并发读写操作

![image-20200424181142265](assets/image-20200424181142265.png)

![image-20200424181323608](assets/image-20200424181323608.png)

![image-20200424181434305](assets/image-20200424181434305.png)

```
拿到上次的 if_seq_no 和 id_primary_term 进行更新
如果多个人拿到 相同的 if_seq_no 和 id_primary_term， 则更新失败
```

![image-20200424181558352](assets/image-20200424181558352.png)

![image-20200424181658411](assets/image-20200424181658411.png)

```
这种事针对 版本的控制实在 MySQL 数据库这种的外部数据
```

### Bucket&Metric聚合分析及嵌套聚合

![image-20200424181846371](assets/image-20200424181846371.png)

![image-20200424181939966](assets/image-20200424181939966.png)

![image-20200424181959460](assets/image-20200424181959460.png)

![image-20200424182122339](assets/image-20200424182122339.png)

![image-20200424182150152](assets/image-20200424182150152.png)

![image-20200424182208857](assets/image-20200424182208857.png)

![image-20200424182241954](assets/image-20200424182241954.png)

![image-20200424182255683](assets/image-20200424182255683.png)

![image-20200424182325426](assets/image-20200424182325426.png)

![image-20200424182344313](assets/image-20200424182344313.png)

![image-20200424182431300](assets/image-20200424182431300.png)

![image-20200424182521427](assets/image-20200424182521427.png)

![image-20200424182611719](assets/image-20200424182611719.png)

![image-20200424182744510](assets/image-20200424182744510.png)

![image-20200424182809489](assets/image-20200424182809489.png)

```
使用 keyword 不会进行分词
```

![image-20200424182915343](assets/image-20200424182915343.png)

![image-20200424182930005](assets/image-20200424182930005.png)

![image-20200424183028936](assets/image-20200424183028936.png)

![image-20200424183042005](assets/image-20200424183042005.png)

![image-20200424183147951](assets/image-20200424183147951.png)

![image-20200424183210299](assets/image-20200424183210299.png)

```
eager_global_ordinals: true 打开，每当有新的数据写入的时候，就可以加载到cache 中，这时候进行 聚合 的时候，性能就会有所提升
聚合查询十分频繁的时候可以打开
```

![image-20200424183339059](assets/image-20200424183339059.png)

![image-20200424183607570](assets/image-20200424183607570.png)

![image-20200424183701860](assets/image-20200424183701860.png)

![image-20200424183741213](assets/image-20200424183741213.png)

![image-20200424183813588](assets/image-20200424183813588.png)

![image-20200424183927371](assets/image-20200424183927371.png)

### Pipeline 聚合分析

![image-20200424184133798](assets/image-20200424184133798.png)

![image-20200424184318463](assets/image-20200424184318463.png)

![image-20200424184458481](assets/image-20200424184458481.png)

![image-20200424184521419](assets/image-20200424184521419.png)

![image-20200424184539868](assets/image-20200424184539868.png)

![image-20200424184615310](assets/image-20200424184615310.png)

![image-20200424185014289](assets/image-20200424185014289.png)

![image-20200424185137004](assets/image-20200424185137004.png)

![image-20200424185215642](assets/image-20200424185215642.png)

### 作用范围与排序

![image-20200424185310524](assets/image-20200424185310524.png)

![image-20200424185420408](assets/image-20200424185420408.png)

```
对查询的结果 进行 聚合分析
```

![image-20200424185603096](assets/image-20200424185603096.png)

```
使用 filter 在 aggs 内进行过滤后聚合分析
```

![image-20200424185737937](assets/image-20200424185737937.png)

![image-20200424185851967](assets/image-20200424185851967.png)

```
all:  global: {} 跳出 query 的限定，对所有文档进行查询 聚合
```

![image-20200424190043914](assets/image-20200424190043914.png)

![image-20200424190321405](assets/image-20200424190321405.png)

![image-20200424190417467](assets/image-20200424190417467.png)

### 聚合分析的原理及精准度的问题

![image-20200424190553894](assets/image-20200424190553894.png)

![image-20200424190630687](assets/image-20200424190630687.png)

![image-20200424190714223](assets/image-20200424190714223.png)

![image-20200424190734743](assets/image-20200424190734743.png)

![image-20200424190831578](assets/image-20200424190831578.png)

![image-20200424191044529](assets/image-20200424191044529.png)

![image-20200424191216072](assets/image-20200424191216072.png)

![image-20200424191258557](assets/image-20200424191258557.png)

![image-20200424191450103](assets/image-20200424191450103.png)

```
通过调整 shard_size：10，来降低 doc_count_error_upper_bound 的值
```

### 对象及Nested 对象

![image-20200424191710068](assets/image-20200424191710068.png)

![image-20200424191820035](assets/image-20200424191820035.png)

![image-20200424191906676](assets/image-20200424191906676.png)

![image-20200424191951722](assets/image-20200424191951722.png)

![image-20200424192029899](assets/image-20200424192029899.png)

![image-20200424192045957](assets/image-20200424192045957.png)

![image-20200424192206363](assets/image-20200424192206363.png)

![image-20200424192306017](assets/image-20200424192306017.png)

![image-20200424192324213](assets/image-20200424192324213.png)

![image-20200424192413517](assets/image-20200424192413517.png)

```
错误的搜索结果 就不会命中了
```

![image-20200424192646282](assets/image-20200424192646282.png)

![image-20200424192725697](assets/image-20200424192725697.png)

![image-20200424192811341](assets/image-20200424192811341.png)

![image-20200424192845627](assets/image-20200424192845627.png)

### 文档的父子关系

![image-20200424192954354](assets/image-20200424192954354.png)

![image-20200424193036734](assets/image-20200424193036734.png)

![image-20200424193119801](assets/image-20200424193119801.png)

![image-20200424193217277](assets/image-20200424193217277.png)

![image-20200424193310817](assets/image-20200424193310817.png)

![image-20200424193546146](assets/image-20200424193546146.png)

![image-20200424193702356](assets/image-20200424193702356.png)

![image-20200424193747700](assets/image-20200424193747700.png)

### UpdateByQuery&ReindexAPI

![image-20200424193929404](assets/image-20200424193929404.png)

![image-20200424194101607](assets/image-20200424194101607.png)

![image-20200424194218657](assets/image-20200424194218657.png)

```
执行 _update_by_query 在更改mapping 信息之前的文档 也可以查看到了
```

![image-20200424194331099](assets/image-20200424194331099.png)

![image-20200424194427020](assets/image-20200424194427020.png)

![image-20200424194508702](assets/image-20200424194508702.png)

![image-20200424194559643](assets/image-20200424194559643.png)

![image-20200424194720030](assets/image-20200424194720030.png)

![image-20200424194812600](assets/image-20200424194812600.png)

### IngestPipeline&PainlessScript

![image-20200424194946723](assets/image-20200424194946723.png)

![image-20200424195049149](assets/image-20200424195049149.png)

![image-20200424195150846](assets/image-20200424195150846.png)

![image-20200424195249894](assets/image-20200424195249894.png)

![image-20200424195348178](assets/image-20200424195348178.png)

![image-20200424195447890](assets/image-20200424195447890.png)

![image-20200424195459793](assets/image-20200424195459793.png)

![image-20200424195523736](assets/image-20200424195523736.png)

![image-20200424195723417](assets/image-20200424195723417.png)

```
对于使用pipeline 和 没有使用 pipeline 插入数据存在差异的时候，可以使用 ——update_by_query 进行更改时指定条件
```

![image-20200424195843556](assets/image-20200424195843556.png)

![image-20200424195937386](assets/image-20200424195937386.png)

![image-20200424200029477](assets/image-20200424200029477.png)

![image-20200424200148227](assets/image-20200424200148227.png)

![image-20200424200228156](assets/image-20200424200228156.png)

![image-20200424200309258](assets/image-20200424200309258.png)

![image-20200424200448001](assets/image-20200424200448001.png)

![image-20200424200651999](assets/image-20200424200651999.png)

![image-20200424200740161](assets/image-20200424200740161.png)

![image-20200424200905173](assets/image-20200424200905173.png)

![image-20200424200949352](assets/image-20200424200949352.png)

### Elasticsearch数据建模实例

![image-20200424201108310](assets/image-20200424201108310.png)

![image-20200424201153688](assets/image-20200424201153688.png)

![image-20200424201211542](assets/image-20200424201211542.png)

![image-20200424201338650](assets/image-20200424201338650.png)

![image-20200424201507877](assets/image-20200424201507877.png)

![image-20200424201614053](assets/image-20200424201614053.png)

![image-20200424201635381](assets/image-20200424201635381.png)

![image-20200424201754191](assets/image-20200424201754191.png)

![image-20200424201830933](assets/image-20200424201830933.png)

![image-20200424202051912](assets/image-20200424202051912.png)

![image-20200424202239507](assets/image-20200424202239507.png)

![image-20200424202430865](assets/image-20200424202430865.png)

![image-20200424202627787](assets/image-20200424202627787.png)

![image-20200424202704788](assets/image-20200424202704788.png)

### Elasticsearch数据建模的最佳实践

![image-20200424202857803](assets/image-20200424202857803.png)

![image-20200424202945024](assets/image-20200424202945024.png)

![image-20200424203026882](assets/image-20200424203026882.png)

![image-20200424203109600](assets/image-20200424203109600.png)

![image-20200424203150651](assets/image-20200424203150651.png)

![image-20200424203337585](assets/image-20200424203337585.png)

![image-20200424203447407](assets/image-20200424203447407.png)

![image-20200424203525302](assets/image-20200424203525302.png)

![image-20200424203545400](assets/image-20200424203545400.png)

![image-20200424203704607](assets/image-20200424203704607.png)

![image-20200424204124871](assets/image-20200424204124871.png)

![image-20200424204305624](assets/image-20200424204305624.png)

### 第二部分总结回顾

![image-20200424204422833](assets/image-20200424204422833.png)

![image-20200424204504990](assets/image-20200424204504990.png)

![image-20200424204607564](assets/image-20200424204607564.png)

![image-20200424204647921](assets/image-20200424204647921.png)

```
数据量少的时候，分片多的时候，算分会不准
```

![image-20200424204756543](assets/image-20200424204756543.png)

### 集群身份认证与用户鉴权

![image-20200424205352417](assets/image-20200424205352417.png)

![image-20200424205415892](assets/image-20200424205415892.png)

![image-20200424205458514](assets/image-20200424205458514.png)

![image-20200424205552524](assets/image-20200424205552524.png)

![image-20200424205641283](assets/image-20200424205641283.png)

![image-20200424205723464](assets/image-20200424205723464.png)

![image-20200424205751370](assets/image-20200424205751370.png)

![image-20200424205808802](assets/image-20200424205808802.png)

![image-20200424205859228](assets/image-20200424205859228.png)

![image-20200424210001920](assets/image-20200424210001920.png)

![image-20200424210046172](assets/image-20200424210046172.png)

![image-20200424210125502](assets/image-20200424210125502.png)

### 集群内部安全通信

![image-20200424210334392](assets/image-20200424210334392.png)

![image-20200425210524533](assets/image-20200425210524533.png)

![image-20200425210547525](assets/image-20200425210547525.png)

![image-20200425210609584](assets/image-20200425210609584.png)

```
生成CA证书
```

![image-20200425210924477](assets/image-20200425210924477.png)

![image-20200425210941181](assets/image-20200425210941181.png)

![image-20200425210958190](assets/image-20200425210958190.png)

```
签发的证书
```

![image-20200425211054235](assets/image-20200425211054235.png)

![image-20200425211311375](assets/image-20200425211311375.png)

```
启动集群
```

### 集群与外部间的通信

![image-20200425211402553](assets/image-20200425211402553.png)

![image-20200425211422007](assets/image-20200425211422007.png)

![image-20200425211541912](assets/image-20200425211541912.png)

![image-20200425211640397](assets/image-20200425211640397.png)

```
导出 kibana 需要使用的 pem的证书
```

![image-20200425211746485](assets/image-20200425211746485.png)

```
修改 kibana.yml 配置文件
```

![image-20200425211943270](assets/image-20200425211943270.png)

![image-20200425212004437](assets/image-20200425212004437.png)

![image-20200425212052780](assets/image-20200425212052780.png)

```
修改 kibana.yml 配置文件，配置访问 kibana web 页面的支持
```

![image-20200425212301814](assets/image-20200425212301814.png)

### Elasticsearch的常见的部署方式

![image-20200425212350512](assets/image-20200425212350512.png)

![image-20200425212457493](assets/image-20200425212457493.png)

![image-20200425212524592](assets/image-20200425212524592.png)

![image-20200425212633885](assets/image-20200425212633885.png)

![image-20200425212743325](assets/image-20200425212743325.png)

![image-20200425212923285](assets/image-20200425212923285.png)

![image-20200425213017583](assets/image-20200425213017583.png)

![image-20200425213041086](assets/image-20200425213041086.png)

![image-20200425213113990](assets/image-20200425213113990.png)

```
ingest 可以通过 pipeline的方式，对插入的数据进行预处理
```

![image-20200425213225008](assets/image-20200425213225008.png)

![image-20200425213312895](assets/image-20200425213312895.png)

```
GTM：全局流量管理
```

### Host & Warm架构与Shard Filtering

![image-20200425213600555](assets/image-20200425213600555.png)

![image-20200425213700245](assets/image-20200425213700245.png)

![image-20200425213944077](assets/image-20200425213944077.png)

![image-20200425214025434](assets/image-20200425214025434.png)

![image-20200425214051032](assets/image-20200425214051032.png)

![image-20200425214143978](assets/image-20200425214143978.png)

![image-20200425214236207](assets/image-20200425214236207.png)

![image-20200425214315722](assets/image-20200425214315722.png)

![image-20200425214437326](assets/image-20200425214437326.png)

![image-20200425214500305](assets/image-20200425214500305.png)

![image-20200425214559999](assets/image-20200425214559999.png)

![image-20200425214710864](assets/image-20200425214710864.png)

![image-20200425214821710](assets/image-20200425214821710.png)

```
强制必须有 rack1 和 rack2 的情况下，分片才能进行分配
```

![image-20200425215043215](assets/image-20200425215043215.png)

![image-20200425215148078](assets/image-20200425215148078.png)

### 分片设计与管理

![image-20200425215315097](assets/image-20200425215315097.png)

![image-20200425215410200](assets/image-20200425215410200.png)

![image-20200425220028739](assets/image-20200425220028739.png)

![image-20200425220523699](assets/image-20200425220523699.png)

![image-20200425220729675](assets/image-20200425220729675.png)

![image-20200425220845593](assets/image-20200425220845593.png)

![image-20200425220952033](assets/image-20200425220952033.png)

![image-20200425221100382](assets/image-20200425221100382.png)

### 如何对集群进行容量规划

![image-20200425221352794](assets/image-20200425221352794.png)

![image-20200425221454770](assets/image-20200425221454770.png)

![image-20200425221542362](assets/image-20200425221542362.png)

![image-20200425221724832](assets/image-20200425221724832.png)

![image-20200425221746550](assets/image-20200425221746550.png)

![image-20200425221859818](assets/image-20200425221859818.png)

![image-20200425222048006](assets/image-20200425222048006.png)

![image-20200425222151679](assets/image-20200425222151679.png)

![image-20200425222301863](assets/image-20200425222301863.png)

![image-20200425222349525](assets/image-20200425222349525.png)

![image-20200425222445238](assets/image-20200425222445238.png)

![image-20200425222537118](assets/image-20200425222537118.png)

### 在私有云上管理Elasticsearch集群的一些方法

![image-20200425222708255](assets/image-20200425222708255.png)

![image-20200425222806838](assets/image-20200425222806838.png)

![image-20200425222908079](assets/image-20200425222908079.png)

![image-20200425222944716](assets/image-20200425222944716.png)

![image-20200425223020330](assets/image-20200425223020330.png)

![image-20200425223115167](assets/image-20200425223115167.png)

![image-20200425223230964](assets/image-20200425223230964.png)

![image-20200425223241355](assets/image-20200425223241355.png)

### 在公有云上部署Elasticsearch集群

![image-20200425223511157](assets/image-20200425223511157.png)

```
使用 Elastic Cloud 进行 Elasticsearch集群创建
```

![image-20200425223616343](assets/image-20200425223616343.png)

![image-20200425223657257](assets/image-20200425223657257.png)

![image-20200425223806512](assets/image-20200425223806512.png)

![image-20200425223823369](assets/image-20200425223823369.png)

### 生产环境常用配置与上线清单

![image-20200425224224288](assets/image-20200425224224288.png)

![image-20200425224342436](assets/image-20200425224342436.png)

![image-20200425224448512](assets/image-20200425224448512.png)

```
JVM 在内存小于32G的时候，会使用 一个指针压缩的技术，当大于32G的时候，会引起性能的下降
```

![image-20200425224729794](assets/image-20200425224729794.png)

![image-20200425224831533](assets/image-20200425224831533.png)

![image-20200425224955205](assets/image-20200425224955205.png)

![image-20200425225252254](assets/image-20200425225252254.png)

![image-20200425225355335](assets/image-20200425225355335.png)

![image-20200425225434626](assets/image-20200425225434626.png)

![image-20200425225458548](assets/image-20200425225458548.png)

![image-20200425225514686](assets/image-20200425225514686.png)

![image-20200425225614910](assets/image-20200425225614910.png)

### 监控Elasticsearch集群

![image-20200425225650485](assets/image-20200425225650485.png)

![image-20200425225713156](assets/image-20200425225713156.png)

![image-20200425225757867](assets/image-20200425225757867.png)

![image-20200425230130193](assets/image-20200425230130193.png)

### 诊断集群的潜在问题

![image-20200425230251557](assets/image-20200425230251557.png)

```
support diagnosis Elatic 开发的集群诊断工具
```

![image-20200425230417304](assets/image-20200425230417304.png)

![image-20200425230514082](assets/image-20200425230514082.png)

![image-20200425230731373](assets/image-20200425230731373.png)

![image-20200425230758091](assets/image-20200425230758091.png)

![image-20200425230838841](assets/image-20200425230838841.png)

![image-20200425230847546](assets/image-20200425230847546.png)

### 解决集群yellow与red的问题

![image-20200425231123672](assets/image-20200425231123672.png)

![image-20200425231259963](assets/image-20200425231259963.png)

```
使用 explain的API找到 创建失败的真正的原因
```



![image-20200425231341029](assets/image-20200425231341029.png)

![image-20200425231749818](assets/image-20200425231749818.png)

![image-20200425231850581](assets/image-20200425231850581.png)

![image-20200425232036575](assets/image-20200425232036575.png)

![image-20200425232125839](assets/image-20200425232125839.png)

### 提升集群的写性能

![image-20200425232414463](assets/image-20200425232414463.png)

![image-20200426085728705](assets/image-20200426085728705.png)

![image-20200426090210550](assets/image-20200426090210550.png)

![image-20200426090601012](assets/image-20200426090601012.png)

![image-20200426090719268](assets/image-20200426090719268.png)

![image-20200426090858043](assets/image-20200426090858043.png)

![image-20200426091042569](assets/image-20200426091042569.png)

![image-20200426091211434](assets/image-20200426091211434.png)

![image-20200426091348355](assets/image-20200426091348355.png)

![image-20200426091515546](assets/image-20200426091515546.png)

### 提升集群的读性能

![image-20200426091619072](assets/image-20200426091619072.png)

![image-20200426091722247](assets/image-20200426091722247.png)

![image-20200426091809217](assets/image-20200426091809217.png)

![image-20200426091835009](assets/image-20200426091835009.png)

```
把 query context 改写为 filter context 优化，查询的时候会利用缓存机制
```

![image-20200426092030713](assets/image-20200426092030713.png)

![image-20200426092043918](assets/image-20200426092043918.png)

![image-20200426092121824](assets/image-20200426092121824.png)

### 集群压力测试

![image-20200426092255464](assets/image-20200426092255464.png)

![image-20200426092402088](assets/image-20200426092402088.png)

![image-20200426092515590](assets/image-20200426092515590.png)

![image-20200426092654901](assets/image-20200426092654901.png)

![image-20200426092729254](assets/image-20200426092729254.png)

![image-20200426092846862](assets/image-20200426092846862.png)

![image-20200426092859301](assets/image-20200426092859301.png)

![image-20200426092935200](assets/image-20200426092935200.png)

```
使用测试数据集的 前 1000 条
```

![image-20200426093038317](assets/image-20200426093038317.png)

![image-20200426093121423](assets/image-20200426093121423.png)

![image-20200426093218945](assets/image-20200426093218945.png)

![image-20200426093318502](assets/image-20200426093318502.png)

![image-20200426093350707](assets/image-20200426093350707.png)

### 段合并优化及注意事项

![image-20200426093606831](assets/image-20200426093606831.png)

![image-20200426093726002](assets/image-20200426093726002.png)

![image-20200426093848691](assets/image-20200426093848691.png)

![image-20200426094033218](assets/image-20200426094033218.png)

### 缓存以及使用reaker限制内存的使用

![image-20200426094205012](assets/image-20200426094205012.png)

![image-20200426094235776](assets/image-20200426094235776.png)

![image-20200426094329362](assets/image-20200426094329362.png)

![image-20200426094436841](assets/image-20200426094436841.png)

![image-20200426094559967](assets/image-20200426094559967.png)

![image-20200426094652025](assets/image-20200426094652025.png)

![image-20200426094815248](assets/image-20200426094815248.png)

![image-20200426094946877](assets/image-20200426094946877.png)

![image-20200426095102655](assets/image-20200426095102655.png)

![image-20200426095209632](assets/image-20200426095209632.png)

![image-20200426095343456](assets/image-20200426095343456.png)

### 一些运维的相关建议

![image-20200426095529311](assets/image-20200426095529311.png)

![image-20200426095633581](assets/image-20200426095633581.png)

```
shard filtering 多架位的部署
```

![image-20200426095805101](assets/image-20200426095805101.png)

![image-20200426095847227](assets/image-20200426095847227.png)

![image-20200426095915983](assets/image-20200426095915983.png)

![image-20200426095939514](assets/image-20200426095939514.png)

![image-20200426104021795](assets/image-20200426104021795.png)

![image-20200426104055073](assets/image-20200426104055073.png)

![image-20200426104147420](assets/image-20200426104147420.png)

![image-20200426104234527](assets/image-20200426104234527.png)

![image-20200426104323383](assets/image-20200426104323383.png)

![image-20200426104418546](assets/image-20200426104418546.png)

![image-20200426104501110](assets/image-20200426104501110.png)

![image-20200426104534351](assets/image-20200426104534351.png)

![image-20200426104611030](assets/image-20200426104611030.png)

![image-20200426104626421](assets/image-20200426104626421.png)

### 使用Shrink 和Rollover API 有效管理时间序列索引

![image-20200426104822119](assets/image-20200426104822119.png)

![image-20200426104920563](assets/image-20200426104920563.png)

![image-20200426105028707](assets/image-20200426105028707.png)

![image-20200426105217805](assets/image-20200426105217805.png)

![image-20200426105401222](assets/image-20200426105401222.png)

![image-20200426105449497](assets/image-20200426105449497.png)

![image-20200426105522057](assets/image-20200426105522057.png)

![image-20200426105602035](assets/image-20200426105602035.png)

![image-20200426105648467](assets/image-20200426105648467.png)

![image-20200426105752032](assets/image-20200426105752032.png)

![image-20200426105826394](assets/image-20200426105826394.png)

![image-20200426105919248](assets/image-20200426105919248.png)

```
和 shrink 是相反的操作，扩展分片的数量
```

![image-20200426110049418](assets/image-20200426110049418.png)

![image-20200426110115409](assets/image-20200426110115409.png)

![image-20200426110130712](assets/image-20200426110130712.png)

![image-20200426110200817](assets/image-20200426110200817.png)

```
不需要 所有的分片都在一个节点上
```

![image-20200426110325750](assets/image-20200426110325750.png)

![image-20200426110446779](assets/image-20200426110446779.png)

![image-20200426110727821](assets/image-20200426110727821.png)

```
创建 alias
```

![image-20200426110847538](assets/image-20200426110847538.png)

![image-20200426110932567](assets/image-20200426110932567.png)

```
alias 执行 0002
```

![image-20200426111200262](assets/image-20200426111200262.png)

```
apache-logs2 执行 rollover的名字，需要以 - 和 数据结尾
设置 is_write_index: true
进行 _count 的统计的时候，统计的是，
```

![image-20200426111459385](assets/image-20200426111459385.png)

![image-20200426111519224](assets/image-20200426111519224.png)

```
写入了 3次的文档
```

![image-20200426111650930](assets/image-20200426111650930.png)

![image-20200426111700370](assets/image-20200426111700370.png)

### 索引全周期生命管理及工具介绍

![image-20200426111828895](assets/image-20200426111828895.png)

![image-20200426112100598](assets/image-20200426112100598.png)

![image-20200426112139790](assets/image-20200426112139790.png)

![image-20200426112226976](assets/image-20200426112226976.png)

![image-20200426112324055](assets/image-20200426112324055.png)

![image-20200426112355700](assets/image-20200426112355700.png)

![image-20200426112415549](assets/image-20200426112415549.png)

![image-20200426112535399](assets/image-20200426112535399.png)

![image-20200426112623633](assets/image-20200426112623633.png)

![image-20200426112724376](assets/image-20200426112724376.png)

![image-20200426112811547](assets/image-20200426112811547.png)

![image-20200426112854868](assets/image-20200426112854868.png)

![image-20200426113037033](assets/image-20200426113037033.png)

```
routing 刚开始创建的时候，会把索引创建在 hot 的节点
```

### Logstash入门及架构介绍

![image-20200426113304851](assets/image-20200426113304851.png)

![image-20200426113421898](assets/image-20200426113421898.png)

![image-20200426113513203](assets/image-20200426113513203.png)

![image-20200426113654635](assets/image-20200426113654635.png)

![image-20200426113734856](assets/image-20200426113734856.png)

![image-20200426113807977](assets/image-20200426113807977.png)

![image-20200426113855319](assets/image-20200426113855319.png)

![image-20200426113915672](assets/image-20200426113915672.png)

![image-20200426114021619](assets/image-20200426114021619.png)

![image-20200426114112896](assets/image-20200426114112896.png)

![image-20200426114141549](assets/image-20200426114141549.png)

![image-20200426114342297](assets/image-20200426114342297.png)

![image-20200426114410097](assets/image-20200426114410097.png)

![image-20200426114504209](assets/image-20200426114504209.png)

![image-20200426114558735](assets/image-20200426114558735.png)

![image-20200426114658378](assets/image-20200426114658378.png)

![image-20200426114721973](assets/image-20200426114721973.png)

![image-20200426114740302](assets/image-20200426114740302.png)

### 利用JDBC插件导入数据到Elasticsearch

![image-20200426115014196](assets/image-20200426115014196.png)

![image-20200426115248400](assets/image-20200426115248400.png)

![image-20200426115407847](assets/image-20200426115407847.png)

![image-20200426115849186](assets/image-20200426115849186.png)

```
对于删除的操作，通过 软删除，创建 alias 过滤 is_deleted：true的数据，进行显示
```

### Beats 介绍

![image-20200426120132327](assets/image-20200426120132327.png)

![image-20200426120228056](assets/image-20200426120228056.png)

![image-20200426120325801](assets/image-20200426120325801.png)

![image-20200426120359848](assets/image-20200426120359848.png)

![image-20200426120447424](assets/image-20200426120447424.png)

![image-20200426120513893](assets/image-20200426120513893.png)

![image-20200426120547683](assets/image-20200426120547683.png)

```
会把 kibana dashboard的数据插入到 Elasticsearch 中
```

![image-20200426120640960](assets/image-20200426120640960.png)

![image-20200426120744709](assets/image-20200426120744709.png)

```
配置 modules/mysql.yml 的配置文件
```

![image-20200426120833099](assets/image-20200426120833099.png)

```
启动 metricbeat 
```

![image-20200426120929912](assets/image-20200426120929912.png)

![image-20200426120958022](assets/image-20200426120958022.png)

![image-20200426121104838](assets/image-20200426121104838.png)

![image-20200426121146679](assets/image-20200426121146679.png)

![image-20200426121225631](assets/image-20200426121225631.png)

![image-20200426121306088](assets/image-20200426121306088.png)

![image-20200426121330256](assets/image-20200426121330256.png)

![image-20200426121420807](assets/image-20200426121420807.png)

### 使用 index pattern 配置数据

![image-20200426121609558](assets/image-20200426121609558.png)

![image-20200426121542792](assets/image-20200426121542792.png)

```
日志信息进行导入
```

![image-20200426121652912](assets/image-20200426121652912.png)

```
账户信息进行导入
```

![image-20200426121733636](assets/image-20200426121733636.png)

![image-20200426121746617](assets/image-20200426121746617.png)

![image-20200426121943530](assets/image-20200426121943530.png)

```
searchable 表示字段可以被搜索到的
aggregate 表示此字段可以被聚合操作的
```

![image-20200426122115754](assets/image-20200426122115754.png)

```
编辑字段段 format 格式 ，可以更加友好的展示 url
```

### 使用kibana discover 探索数据

![image-20200426122352034](assets/image-20200426122352034.png)

### 基本可视化组件介绍

![image-20200426123500306](assets/image-20200426123500306.png)

### 构建dashboard

![image-20200426123657761](assets/image-20200426123657761.png)

![image-20200426123745632](assets/image-20200426123745632.png)

![image-20200426123807637](assets/image-20200426123807637.png)

### 使用monitoring和Alerting 监控Elasticsearch集群

![image-20200426124126366](assets/image-20200426124126366.png)

![image-20200426124145685](assets/image-20200426124145685.png)

![image-20200426124209006](assets/image-20200426124209006.png)

### 使用APM对程序应用性能监控

![image-20200426125545020](assets/image-20200426125545020.png)

![image-20200426125649468](assets/image-20200426125649468.png)

![image-20200426125723837](assets/image-20200426125723837.png)

![image-20200426125752668](assets/image-20200426125752668.png)

![image-20200426125816471](assets/image-20200426125816471.png)

![image-20200426125842381](assets/image-20200426125842381.png)

### 使用机器学习实现时序数据的异常检测

![image-20200426130417497](assets/image-20200426130417497.png)

![image-20200426130519816](assets/image-20200426130519816.png)

![image-20200426130613527](assets/image-20200426130613527.png)

![image-20200426130742062](assets/image-20200426130742062.png)

![image-20200426130827692](assets/image-20200426130827692.png)

![image-20200426130857750](assets/image-20200426130857750.png)

![image-20200426130926765](assets/image-20200426130926765.png)

![image-20200426131011946](assets/image-20200426131011946.png)

### 使用ELK进行日志的集中管理

![image-20200426131828275](assets/image-20200426131828275.png)

![image-20200426131910675](assets/image-20200426131910675.png)

![image-20200426131955011](assets/image-20200426131955011.png)

![image-20200426132035154](assets/image-20200426132035154.png)

![image-20200426132120169](assets/image-20200426132120169.png)

![image-20200426132231911](assets/image-20200426132231911.png)

![image-20200426132303815](assets/image-20200426132303815.png)

![image-20200426132347237](assets/image-20200426132347237.png)

![image-20200426132412477](assets/image-20200426132412477.png)

![image-20200426132459092](assets/image-20200426132459092.png)

![image-20200426132546500](assets/image-20200426132546500.png)

### 使用cavas 做数据演示

![image-20200426132820817](assets/image-20200426132820817.png)

![image-20200426132928539](assets/image-20200426132928539.png)

![image-20200426133028859](assets/image-20200426133028859.png)

![image-20200426133232159](assets/image-20200426133232159.png)

### 项目需求分析及架构设计

![image-20200426133314224](assets/image-20200426133314224.png)

![image-20200426133344304](assets/image-20200426133344304.png)

![image-20200426133356603](assets/image-20200426133356603.png)

![image-20200426133431527](assets/image-20200426133431527.png)

![image-20200426133506124](assets/image-20200426133506124.png)

![image-20200426133541325](assets/image-20200426133541325.png)

![image-20200426133631463](assets/image-20200426133631463.png)

### 将电影数据导入Elasticsearch

![image-20200426133902985](assets/image-20200426133902985.png)

![image-20200426133919587](assets/image-20200426133919587.png)

![image-20200426133949003](assets/image-20200426133949003.png)

![image-20200426133958530](assets/image-20200426133958530.png)

![image-20200426134055995](assets/image-20200426134055995.png)

![image-20200426134106887](assets/image-20200426134106887.png)

![image-20200426134145672](assets/image-20200426134145672.png)

```
导入数据
```

![image-20200426134226047](assets/image-20200426134226047.png)

### 搭建你的电影搜索服务

![image-20200426134345342](assets/image-20200426134345342.png)

![image-20200426134401020](assets/image-20200426134401020.png)

![image-20200426134420605](assets/image-20200426134420605.png)

```
使用 reference UI 生成的前端框架
```

![image-20200426134508716](assets/image-20200426134508716.png)

![image-20200426134549926](assets/image-20200426134549926.png)

![image-20200426134655706](assets/image-20200426134655706.png)

![image-20200426134751795](assets/image-20200426134751795.png)

![image-20200426134813727](assets/image-20200426134813727.png)

![image-20200426134834889](assets/image-20200426134834889.png)

![image-20200426134851427](assets/image-20200426134851427.png)

![image-20200426134920964](assets/image-20200426134920964.png)

![image-20200426135104391](assets/image-20200426135104391.png)

```
添加同义词
```

![image-20200426135223376](assets/image-20200426135223376.png)

![image-20200426135239470](assets/image-20200426135239470.png)

```
提升算分
```

### 需求分析及架构设计

![image-20200426135408341](assets/image-20200426135408341.png)

![image-20200426135537249](assets/image-20200426135537249.png)

![image-20200426135513531](assets/image-20200426135513531.png)

### 数据Extract & Enrichment

![image-20200426135711221](assets/image-20200426135711221.png)

```
input {
  file {
    path => "/Users/yiruan/geektime/logstash-7.3.2/survey_results_public.csv"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

filter {
  csv {
        autogenerate_column_names => false
        skip_empty_columns => true

        columns => [
         "Respondent","MainBranch","Hobbyist","OpenSourcer","OpenSource","Employment","Country","Student","EdLevel","UndergradMajor","EduOther","OrgSize","DevType","YearsCode","Age1stCode","YearsCodePro","CareerSat","JobSat","MgrIdiot","MgrMoney","MgrWant","JobSeek","LastHireDate","LastInt","FizzBuzz","JobFactors","ResumeUpdate","CurrencySymbol","CurrencyDesc","CompTotal","CompFreq","ConvertedComp","WorkWeekHrs","WorkPlan","WorkChallenge","WorkRemote","WorkLoc","ImpSyn","CodeRev","CodeRevHrs","UnitTests","PurchaseHow","PurchaseWhat","LanguageWorkedWith","LanguageDesireNextYear","DatabaseWorkedWith","DatabaseDesireNextYear","PlatformWorkedWith","PlatformDesireNextYear","WebFrameWorkedWith","WebFrameDesireNextYear","MiscTechWorkedWith","MiscTechDesireNextYear","DevEnviron","OpSys","Containers","BlockchainOrg","BlockchainIs","BetterLife","ITperson","OffOn","SocialMedia","Extraversion","ScreenName","SOVisit1st","SOVisitFreq","SOVisitTo","SOFindAnswer","SOTimeSaved","SOHowMuchTime","SOAccount","SOPartFreq","SOJobs","EntTeams","SOComm","WelcomeChange","SONewContent","Age","Gender","Trans,Sexuality","Ethnicity","Dependents","SurveyLength","SurveyEase"
        ]

      }
  if ([collector] == "collector") {
    drop {}
  }
  mutate { remove_field => ["message", "@version", "@timestamp", "host"] }
}
output {
  stdout { codec => "dots" }
  elasticsearch {
                hosts => ["http://localhost:9200"]  
    index => "stackoverflow-survey-raw"
                document_type => "_doc"
                }
}
```

![image-20200426140024787](assets/image-20200426140024787.png)

```
匹配到字段为 string 的时候，把字段映射为 keyword
```

![image-20200426153746758](assets/image-20200426153746758.png)

![image-20200426153811180](assets/image-20200426153811180.png)

![image-20200426153900862](assets/image-20200426153900862.png)

![image-20200426153917735](assets/image-20200426153917735.png)

```
mapping 信息转换为正确的类型
```

### 构建insights Dashboard

![image-20200426154129499](assets/image-20200426154129499.png)

![image-20200426154304952](assets/image-20200426154304952.png)

![image-20200426154338520](assets/image-20200426154338520.png)

### Elastic 认证介绍

 

![image-20200426154502355](assets/image-20200426154502355.png)

![image-20200426154535977](assets/image-20200426154535977.png)

![image-20200426154547297](assets/image-20200426154547297.png)

![image-20200426154626978](assets/image-20200426154626978.png)

![image-20200426154644643](assets/image-20200426154644643.png)

![image-20200426154727653](assets/image-20200426154727653.png)

![image-20200426154844210](assets/image-20200426154844210.png)

![image-20200426154921530](assets/image-20200426154921530.png)

![image-20200426154947642](assets/image-20200426154947642.png)

![image-20200426155020665](assets/image-20200426155020665.png)

![image-20200426155045364](assets/image-20200426155045364.png)

### 考点梳理

![image-20200426155230057](assets/image-20200426155230057.png)

![image-20200426155341799](assets/image-20200426155341799.png)

### 集群数据备份

![image-20200426155955661](assets/image-20200426155955661.png)

![image-20200426160058879](assets/image-20200426160058879.png)

![image-20200426160146638](assets/image-20200426160146638.png)

![image-20200426160200246](assets/image-20200426160200246.png)

```
运行Elasticsearch
```

![image-20200426160231630](assets/image-20200426160231630.png)

```
注册 repository
```

![image-20200426160325603](assets/image-20200426160325603.png)

![image-20200426160359114](assets/image-20200426160359114.png)

![image-20200426160426965](assets/image-20200426160426965.png)

![image-20200426160506920](assets/image-20200426160506920.png)

```
恢复之前，备份的数据不能已 存在于es中
```

![image-20200426160559606](assets/image-20200426160559606.png)

```
备份的文件
```

