## iptables 学习笔记

[TOC]

**参考博客：http://www.zsythink.net/archives/1199**

### iptables概念

iptables 其实不是真正的防火墙，可以理解成一个**客户端的代理**，通过iptables 这个代理，将用户的安全设定执行到对应的安全框架中，这个安全框架就是真正的防火墙，这个框架是 **netfilter**。

**netfilter** 是防火墙真正的安全框架，位于Linux的 **内核空间。**

**iptables** 其实是一个命令行的工具，位于 Linux的 **用户空间** ，我们使用 iptables 这个工具操作 netfilter 的安全框架。

**netfilter** 是Linux操作系统核心层的一个数据包处理模块，具有如下的功能：

1. 网络地址转换（Network Address Translate）
2. 数据包的内容修改
3. 数据包过滤（防火墙）

我们使用 service iptables start 启动iptables 的服务，其实准确的来说，iptables 并没有一个守护进程，并不是一个真正意义上的服务，而是 **内核提供的一个功能**。

### iptables基础

![image-20200408113021737](assets/image-20200408113021737.png)

![image-20200408113121613](assets/image-20200408113121613.png)

![image-20200408113358456](assets/image-20200408113358456.png)

### 链的概念

![image-20200408133143922](assets/image-20200408133143922.png)

### 表的概念

![image-20200408133552650](assets/image-20200408133552650.png)

![image-20200409120830797](assets/image-20200409120830797.png)

### 表链关系

![image-20200408134244618](assets/image-20200408134244618.png)

![image-20200408134936586](assets/image-20200408134936586.png)

![image-20200408135103491](assets/image-20200408135103491.png)

![image-20200408135149807](assets/image-20200408135149807.png)

![image-20200408135325331](assets/image-20200408135325331.png)

![image-20200408135456088](assets/image-20200408135456088.png)

### 数据包经过防火墙的流程

![image-20200408135637793](assets/image-20200408135637793.png)

![image-20200408135747863](assets/image-20200408135747863.png)

### 规则的概念

![image-20200408140100692](assets/image-20200408140100692.png)

![image-20200408140205297](assets/image-20200408140205297.png)

![image-20200408140353509](assets/image-20200408140353509.png)

### iptables规则查询

![image-20200408141108193](assets/image-20200408141108193.png)

![image-20200408141540032](assets/image-20200408141540032.png)

![image-20200408141645753](assets/image-20200408141645753.png)

![image-20200408141850957](assets/image-20200408141850957.png)

![image-20200408142048936](assets/image-20200408142048936.png)

![image-20200408142126165](assets/image-20200408142126165.png)

![image-20200408142524932](assets/image-20200408142524932.png)

### iptables规则管理

![image-20200408144011656](assets/image-20200408144011656.png)

#### 增加规则

![image-20200408144345499](assets/image-20200408144345499.png)

![image-20200408144540456](assets/image-20200408144540456.png)

![image-20200408144736953](assets/image-20200408144736953.png)

![image-20200408144959596](assets/image-20200408144959596.png)

#### 删除规则

![image-20200408145137342](assets/image-20200408145137342.png)

![image-20200408145220717](assets/image-20200408145220717.png)

![image-20200408145317427](assets/image-20200408145317427.png)

#### 修改规则

![image-20200408145808926](assets/image-20200408145808926.png)

#### 保存规则

![image-20200408150005446](assets/image-20200408150005446.png)

### iptables匹配条件总结

#### 匹配条件的更多的用法

![image-20200408153807398](assets/image-20200408153807398.png)

![image-20200408153830880](assets/image-20200408153830880.png)

![image-20200408153913673](assets/image-20200408153913673.png)

```
按照上面的配置，如果此时 从146 的机器上 向防火墙所在的主机 ping 请求，146 的主机能得到回应吗？（不考虑其他链，只考虑INPUT链）
答案是： 能
上面的规则表达的意思是：源IP不是192.168.1.146 的报文就接收。但是并不代表源IP 是192.168.1.146 时就进行拒绝。上述，没有任何一条的规则限定 源IP是 192.168.1.146 的ip 执行何种操作，所以执行默认的操作ACCEPT
```

#### 匹配条件：目标IP地址

![image-20200408155229630](assets/image-20200408155229630.png)

```
当一条的规则中存在多个戴尔匹配条件的时候，报文必须都满足这些条件，才算被规则匹配，多个规则之间是与的关系。
```

#### 匹配条件：协议类型

![image-20200408155654971](assets/image-20200408155654971.png)

#### 匹配条件：网卡接口

![image-20200408155855115](assets/image-20200408155855115.png)

![image-20200408160027340](assets/image-20200408160027340.png)

#### 扩展匹配条件

![image-20200408221745947](assets/image-20200408221745947.png)

![image-20200408221828305](assets/image-20200408221828305.png)

![image-20200408222042002](assets/image-20200408222042002.png)

![image-20200408222239143](assets/image-20200408222239143.png)

![image-20200408222309962](assets/image-20200408222309962.png)

![image-20200408222434720](assets/image-20200408222434720.png)

![image-20200408222550915](assets/image-20200408222550915.png)

#### iprange扩展模块

![image-20200408223132771](assets/image-20200408223132771.png)

#### string扩展模块

![image-20200408223400714](assets/image-20200408223400714.png)

#### time扩展模块

![image-20200408223747416](assets/image-20200408223747416.png)

![image-20200408223838158](assets/image-20200408223838158.png)

#### connlimit扩展模块

![image-20200408224504156](assets/image-20200408224504156.png)

![image-20200408224526986](assets/image-20200408224526986.png)

![image-20200408224836251](assets/image-20200408224836251.png)

#### limit扩展模块

![image-20200408225704237](assets/image-20200408225704237.png)

```
原因是 6s 的时候的数据包是匹配，这条规则进行放行的，而 6s之前的包没有匹配这条规则，则继续往下面的规则匹配，匹配到默认的规则进行了放行。
```

![image-20200408225912797](assets/image-20200408225912797.png)

```
最开始的 5个ping 包是通的，这是因为 --limit-burst 的默认值是5，桶中默认已经存在了5个令牌
```

![image-20200408230106960](assets/image-20200408230106960.png)

![image-20200408230134499](assets/image-20200408230134499.png)

#### 扩展匹配条件之 “--tcp-flags”

![image-20200408230928193](assets/image-20200408230928193.png)

![image-20200408231356465](assets/image-20200408231356465.png)

![image-20200408231438863](assets/image-20200408231438863.png)

![image-20200408231819611](assets/image-20200408231819611.png)

![image-20200408231946574](assets/image-20200408231946574.png)

#### 扩展匹配之udp和icmp扩展

![image-20200408232126182](assets/image-20200408232126182.png)

![image-20200408232348545](assets/image-20200408232348545.png)

![image-20200408232620474](assets/image-20200408232620474.png)

![image-20200408232827920](assets/image-20200408232827920.png)

![image-20200408233022226](assets/image-20200408233022226.png)

![image-20200408233105001](assets/image-20200408233105001.png)

#### 扩展模块之state模块

![image-20200409001044192](assets/image-20200409001044192.png)

```
我们的客户端为了 链接 http或ssh 服务，开放了 80 或22 的端口的回包，但是如果其他的主机 通过80 恶意的发送数据到我们的客户端，我们也是可以收到的。
```

![image-20200409001425341](assets/image-20200409001425341.png)


![image-20200409001557768](assets/image-20200409001557768.png)

### iptables的黑白名单机制

![image-20200409083552360](assets/image-20200409083552360.png)

![image-20200409083720538](assets/image-20200409083720538.png)

![image-20200409083808688](assets/image-20200409083808688.png)

### iptables自定义链

![image-20200409084006046](assets/image-20200409084006046.png)

![image-20200409084339492](assets/image-20200409084339492.png)

![image-20200409084817760](assets/image-20200409084817760.png)

![image-20200409084851081](assets/image-20200409084851081.png)

![image-20200409085215306](assets/image-20200409085215306.png)

![image-20200409085429180](assets/image-20200409085429180.png)

![image-20200409085509854](assets/image-20200409085509854.png)

![image-20200409085634905](assets/image-20200409085634905.png)

### iptables之网络防火墙

![image-20200409085908460](assets/image-20200409085908460.png)

```
橘黄色的主机位iptables所在的主机，此时的iptables充当的角色即为网络防火墙；上图中的浅蓝色园形表示网络防火墙所防护的网络区域
```

![image-20200409090208856](assets/image-20200409090208856.png)

#### 环境准备

![image-20200409090658950](assets/image-20200409090658950.png)

![image-20200409091044607](assets/image-20200409091044607.png)

![image-20200409091242690](assets/image-20200409091242690.png)

```
B主机没有开启 内核转发 所以包到了B主机之后，不能进行转发，则不会进行报文转发
```

![image-20200409091616120](assets/image-20200409091616120.png)

#### 网络防火墙测试

![image-20200409092201310](assets/image-20200409092201310.png)

![image-20200409092320440](assets/image-20200409092320440.png)

![image-20200409092517396](assets/image-20200409092517396.png)

![image-20200409092546982](assets/image-20200409092546982.png)

![image-20200409092755578](assets/image-20200409092755578.png)

![image-20200409092902204](assets/image-20200409092902204.png)

#### 小结

![image-20200409092952654](assets/image-20200409092952654.png)

### iptables动作总结之一

#### 动作REJECT

![image-20200409093251959](assets/image-20200409093251959.png)

![image-20200409093358283](assets/image-20200409093358283.png)

![image-20200409093429667](assets/image-20200409093429667.png)

#### 动作LOG

![image-20200409093701226](assets/image-20200409093701226.png)

![image-20200409093807319](assets/image-20200409093807319.png)

![image-20200409093925440](assets/image-20200409093925440.png)

#### 动作MARK

![image-20200409121140776](assets/image-20200409121140776.png)

### iptables动作总结之二

![image-20200409100258825](assets/image-20200409100301427.png)

#### **场景1**

![image-20200409102730197](assets/image-20200409102730197.png)

![image-20200409102837470](assets/image-20200409102837470.png)

![image-20200409102927727](assets/image-20200409102927727.png)

#### **场景2**

![image-20200409103250426](assets/image-20200409103250426.png)

#### 实验环境

![image-20200409103735968](assets/image-20200409103735968.png)

![image-20200409104143754](assets/image-20200409104143754.png)

![image-20200409104547505](assets/image-20200409104547505.png)

#### 动作SNAT

![image-20200409105115901](assets/image-20200409105115901.png)

![image-20200409105244312](assets/image-20200409105244312.png)

![image-20200409105450918](assets/image-20200409105450918.png)

![image-20200409105642790](assets/image-20200409105642790.png)

#### 动作DNAT

![image-20200409110330044](assets/image-20200409110330044.png)

![image-20200409110459835](assets/image-20200409110459835.png)

#### 动作MASQUERADE

![image-20200409110731404](assets/image-20200409110731404.png)

#### 动作REDIRECT

![image-20200409110843847](assets/image-20200409110843847.png)

#### 小结

![image-20200409110947588](assets/image-20200409110947588.png)

![image-20200409111005040](assets/image-20200409111005040.png)

### iptables小结

![image-20200409111304044](assets/image-20200409111304044.png)

